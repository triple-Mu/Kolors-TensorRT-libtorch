//
// Created by ubuntu on 24-07-08.
//
#include "libtrt.hpp"
#include "progressbar.hpp"
#include "pybind11/numpy.h"
#include "pybind11/pybind11.h"
#include "pybind11/stl.h"
#include "torch/extension.h"
#include <algorithm>
#include <iostream>

#define SET_ATTR_TO(m, name, value) m.attr(#name) = value

namespace py = pybind11;

// clang-format off
constexpr float alphas_cumprod[1100] = {0.9991499781608582, 0.9982959628105164, 0.9974379539489746, 0.9965758919715881, 0.9957098364830017, 0.9948397874832153, 0.9939656853675842, 0.9930875301361084, 0.9922053813934326, 0.9913192391395569, 0.9904291033744812, 0.9895349144935608, 0.9886366724967957, 0.9877344369888306, 0.9868282079696655, 0.9859179258346558, 0.9850035905838013, 0.984085202217102, 0.9831628799438477, 0.9822364449501038, 0.9813060164451599, 0.9803715944290161, 0.9794331192970276, 0.9784905910491943, 0.9775440692901611, 0.976593554019928, 0.9756389260292053, 0.9746803641319275, 0.9737177491188049, 0.9727510809898376, 0.9717804193496704, 0.9708057641983032, 0.9698270559310913, 0.9688443541526794, 0.9678575992584229, 0.9668668508529663, 0.9658721089363098, 0.9648733139038086, 0.9638705849647522, 0.9628638029098511, 0.96185302734375, 0.9608381986618042, 0.9598194360733032, 0.9587966203689575, 0.9577698707580566, 0.956739068031311, 0.9557043313980103, 0.9546656012535095, 0.9536228775978088, 0.9525761604309082, 0.9515254497528076, 0.9504708051681519, 0.9494121074676514, 0.9483494758605957, 0.9472829103469849, 0.9462123513221741, 0.9451378583908081, 0.9440593719482422, 0.9429769515991211, 0.9418905973434448, 0.9408003091812134, 0.9397060871124268, 0.938607931137085, 0.9375059008598328, 0.9363998770713806, 0.9352899193763733, 0.9341760873794556, 0.9330583810806274, 0.9319366812705994, 0.9308111071586609, 0.9296815991401672, 0.928548276424408, 0.9274110198020935, 0.9262698888778687, 0.9251248836517334, 0.9239760041236877, 0.9228233098983765, 0.92166668176651, 0.9205062389373779, 0.9193419814109802, 0.9181738495826721, 0.9170019626617432, 0.915826141834259, 0.914646565914154, 0.9134631752967834, 0.9122759699821472, 0.9110849499702454, 0.9098901152610779, 0.9086915254592896, 0.9074891209602356, 0.9062829613685608, 0.9050730466842651, 0.9038593769073486, 0.9026419520378113, 0.9014208316802979, 0.9001958966255188, 0.8989673256874084, 0.8977349400520325, 0.8964989185333252, 0.8952591419219971, 0.8940157294273376, 0.8927685618400574, 0.8915177583694458, 0.8902632594108582, 0.8890051245689392, 0.887743353843689, 0.8864778876304626, 0.8852088451385498, 0.8839361667633057, 0.8826598525047302, 0.8813799619674683, 0.880096435546875, 0.8788093328475952, 0.8775186538696289, 0.8762244582176208, 0.8749266266822815, 0.8736252784729004, 0.8723204135894775, 0.8710120320320129, 0.8697001338005066, 0.8683846592903137, 0.8670657277107239, 0.8657433390617371, 0.8644174337387085, 0.863088071346283, 0.8617552518844604, 0.8604190349578857, 0.8590793609619141, 0.8577362298965454, 0.8563897609710693, 0.8550398945808411, 0.8536865711212158, 0.8523299098014832, 0.8509698510169983, 0.849606454372406, 0.8482397198677063, 0.846869707107544, 0.8454963564872742, 0.8441197276115417, 0.8427397608757019, 0.8413565158843994, 0.839970052242279, 0.838580310344696, 0.8371872901916504, 0.8357911109924316, 0.8343916535377502, 0.832988977432251, 0.8315831422805786, 0.8301741480827332, 0.8287619948387146, 0.827346682548523, 0.8259282112121582, 0.8245066404342651, 0.823081910610199, 0.8216541409492493, 0.8202232718467712, 0.8187893629074097, 0.8173523545265198, 0.8159123659133911, 0.8144692778587341, 0.8130232691764832, 0.8115742206573486, 0.8101221919059753, 0.8086671233177185, 0.8072091937065125, 0.8057482838630676, 0.804284393787384, 0.8028176426887512, 0.8013480305671692, 0.7998755574226379, 0.7984001636505127, 0.7969219088554382, 0.7954408526420593, 0.793956995010376, 0.7924703359603882, 0.790980875492096, 0.7894886136054993, 0.7879936695098877, 0.7864959836006165, 0.7849954962730408, 0.783492386341095, 0.7819865345954895, 0.7804780006408691, 0.7789668440818787, 0.7774530053138733, 0.7759366035461426, 0.774417519569397, 0.7728959321975708, 0.7713717222213745, 0.7698449492454529, 0.7683156132698059, 0.7667837738990784, 0.7652494311332703, 0.7637126445770264, 0.7621733546257019, 0.7606315612792969, 0.7590873837471008, 0.757540762424469, 0.7559917569160461, 0.7544403672218323, 0.7528865933418274, 0.7513304948806763, 0.7497720718383789, 0.7482112646102905, 0.7466481924057007, 0.7450829148292542, 0.7435153126716614, 0.7419454455375671, 0.7403733730316162, 0.7387991547584534, 0.7372227311134338, 0.7356441020965576, 0.7340633273124695, 0.7324804663658142, 0.730895459651947, 0.7293083667755127, 0.7277191877365112, 0.7261279225349426, 0.7245346903800964, 0.7229394316673279, 0.721342146396637, 0.7197428941726685, 0.7181416749954224, 0.7165385484695435, 0.7149335145950317, 0.7133265137672424, 0.7117176651954651, 0.7101069688796997, 0.7084944248199463, 0.7068800330162048, 0.7052639126777649, 0.7036459445953369, 0.7020262479782104, 0.7004047632217407, 0.6987816095352173, 0.6971567273139954, 0.6955301761627197, 0.6939019560813904, 0.6922721266746521, 0.6906406283378601, 0.6890075206756592, 0.6873728632926941, 0.6857366561889648, 0.6840988993644714, 0.6824596524238586, 0.6808188557624817, 0.6791765689849854, 0.6775329113006592, 0.6758877635002136, 0.6742411851882935, 0.6725932359695435, 0.6709439158439636, 0.669293224811554, 0.6676412224769592, 0.6659879088401794, 0.6643332839012146, 0.6626774072647095, 0.6610202789306641, 0.6593619585037231, 0.6577024459838867, 0.6560417413711548, 0.6543798446655273, 0.6527168154716492, 0.651052713394165, 0.6493874788284302, 0.6477211713790894, 0.6460537910461426, 0.6443853974342346, 0.6427159905433655, 0.6410455703735352, 0.6393742561340332, 0.6377019286155701, 0.6360287070274353, 0.6343545913696289, 0.6326795816421509, 0.631003737449646, 0.6293270587921143, 0.6276495456695557, 0.625971257686615, 0.6242921948432922, 0.6226123571395874, 0.6209318041801453, 0.6192505955696106, 0.6175686717033386, 0.6158860921859741, 0.6142028570175171, 0.6125190258026123, 0.6108345985412598, 0.6091496348381042, 0.607464075088501, 0.6057780385017395, 0.604091465473175, 0.6024044156074524, 0.6007168889045715, 0.5990289449691772, 0.5973405838012695, 0.5956518650054932, 0.5939627289772034, 0.5922732949256897, 0.5905835032463074, 0.5888934135437012, 0.5872030258178711, 0.5855123996734619, 0.5838215351104736, 0.5821304321289062, 0.5804391503334045, 0.5787477493286133, 0.5770561695098877, 0.5753644704818726, 0.5736726522445679, 0.5719808340072632, 0.570288896560669, 0.5685969591140747, 0.5669049620628357, 0.5652130246162415, 0.563521146774292, 0.5618292689323425, 0.5601374506950378, 0.5584458112716675, 0.5567542314529419, 0.5550628304481506, 0.5533716082572937, 0.5516805648803711, 0.5499897003173828, 0.5482991337776184, 0.5466088056564331, 0.5449187755584717, 0.5432289838790894, 0.5415396094322205, 0.5398505330085754, 0.5381618738174438, 0.5364735722541809, 0.5347856879234314, 0.5330982208251953, 0.5314112901687622, 0.5297247767448425, 0.5280387997627258, 0.5263532996177673, 0.5246684551239014, 0.5229840874671936, 0.5213003158569336, 0.5196171998977661, 0.5179347395896912, 0.5162529349327087, 0.5145717859268188, 0.5128913521766663, 0.511211633682251, 0.5095326900482178, 0.5078545212745667, 0.5061771273612976, 0.5045005679130554, 0.5028247833251953, 0.5011499524116516, 0.4994759261608124, 0.49780285358428955, 0.49613070487976074, 0.49445948004722595, 0.49278923869132996, 0.49112001061439514, 0.4894517660140991, 0.4877845346927643, 0.4861184060573578, 0.48445332050323486, 0.48278936743736267, 0.4811265170574188, 0.4794647991657257, 0.4778042435646057, 0.4761449098587036, 0.47448673844337463, 0.47282981872558594, 0.47117412090301514, 0.469519704580307, 0.46786659955978394, 0.4662148058414459, 0.46456432342529297, 0.46291521191596985, 0.46126747131347656, 0.4596211314201355, 0.45797622203826904, 0.4563327431678772, 0.45469072461128235, 0.4530501663684845, 0.45141109824180603, 0.4497736096382141, 0.4481376111507416, 0.4465031921863556, 0.44487035274505615, 0.44323912262916565, 0.4416095018386841, 0.4399815499782562, 0.4383552372455597, 0.43673062324523926, 0.4351077079772949, 0.4334865212440491, 0.4318670928478241, 0.4302493929862976, 0.4286334812641144, 0.4270193874835968, 0.4254071116447449, 0.423796683549881, 0.4221881031990051, 0.4205814003944397, 0.41897663474082947, 0.41737374663352966, 0.41577282547950745, 0.4141738712787628, 0.4125768840312958, 0.4109818935394287, 0.409388929605484, 0.40779799222946167, 0.4062091112136841, 0.40462231636047363, 0.4030376076698303, 0.40145501494407654, 0.3998745083808899, 0.39829617738723755, 0.3967200219631195, 0.39514604210853577, 0.3935742676258087, 0.39200472831726074, 0.39043739438056946, 0.388872355222702, 0.38730958104133606, 0.38574910163879395, 0.3841909170150757, 0.38263508677482605, 0.38108158111572266, 0.3795304596424103, 0.37798169255256653, 0.3764353394508362, 0.3748914301395416, 0.3733499348163605, 0.3718108832836151, 0.37027430534362793, 0.3687402009963989, 0.3672086000442505, 0.365679532289505, 0.3641529977321625, 0.3626290261745453, 0.36110758781433105, 0.35958877205848694, 0.35807251930236816, 0.3565589189529419, 0.35504794120788574, 0.3535396158695221, 0.35203394293785095, 0.3505309820175171, 0.3490307033061981, 0.34753313660621643, 0.346038281917572, 0.34454619884490967, 0.343056857585907, 0.34157031774520874, 0.34008654952049255, 0.3386055827140808, 0.3371274471282959, 0.3356521427631378, 0.33417966961860657, 0.3327101171016693, 0.3312433958053589, 0.32977959513664246, 0.32831868529319763, 0.3268606960773468, 0.32540565729141235, 0.3239535689353943, 0.3225044310092926, 0.3210583031177521, 0.3196151554584503, 0.31817498803138733, 0.3167378604412079, 0.315303772687912, 0.313872754573822, 0.3124447762966156, 0.3110198676586151, 0.30959805846214294, 0.3081793487071991, 0.30676376819610596, 0.30535128712654114, 0.3039419651031494, 0.3025358021259308, 0.30113276839256287, 0.29973292350769043, 0.29833629727363586, 0.2969428300857544, 0.2955526113510132, 0.29416558146476746, 0.2927818298339844, 0.29140129685401917, 0.2900240421295166, 0.2886500358581543, 0.287279337644577, 0.2859119176864624, 0.2845478355884552, 0.28318703174591064, 0.2818295657634735, 0.2804754674434662, 0.2791247069835663, 0.2777772843837738, 0.27643322944641113, 0.27509257197380066, 0.2737553119659424, 0.2724214196205139, 0.2710909843444824, 0.2697639465332031, 0.2684403359889984, 0.2671201527118683, 0.2658034563064575, 0.26449018716812134, 0.2631804347038269, 0.26187410950660706, 0.26057130098342896, 0.2592720091342926, 0.2579762041568756, 0.256683886051178, 0.2553951144218445, 0.2541098892688751, 0.2528281807899475, 0.2515500485897064, 0.25027546286582947, 0.24900443851947784, 0.24773699045181274, 0.24647313356399536, 0.2452128529548645, 0.24395617842674255, 0.24270309507846832, 0.2414536327123642, 0.24020777642726898, 0.23896557092666626, 0.23772698640823364, 0.23649203777313232, 0.2352607548236847, 0.23403312265872955, 0.2328091412782669, 0.23158882558345795, 0.23037219047546387, 0.22915923595428467, 0.22794996201992035, 0.2267443835735321, 0.22554251551628113, 0.22434434294700623, 0.2231498807668686, 0.22195912897586823, 0.22077210247516632, 0.21958880126476288, 0.2184092402458191, 0.21723340451717377, 0.2160613089799881, 0.21489296853542328, 0.2137283831834793, 0.2125675529241562, 0.2114104926586151, 0.21025718748569489, 0.2091076523065567, 0.20796188712120056, 0.20681990683078766, 0.205681711435318, 0.20454728603363037, 0.20341666042804718, 0.20228984951972961, 0.20116682350635529, 0.2000475972890854, 0.19893217086791992, 0.1978205442428589, 0.19671274721622467, 0.19560876488685608, 0.19450858235359192, 0.19341222941875458, 0.19231970608234406, 0.19123098254203796, 0.19014610350131989, 0.18906505405902863, 0.18798783421516418, 0.18691444396972656, 0.18584488332271576, 0.18477916717529297, 0.1837172955274582, 0.18265926837921143, 0.18160507082939148, 0.18055473268032074, 0.179508239030838, 0.1784655749797821, 0.1774267703294754, 0.1763918101787567, 0.17536070942878723, 0.17433345317840576, 0.1733100414276123, 0.17229050397872925, 0.171274796128273, 0.17026294767856598, 0.16925495862960815, 0.16825081408023834, 0.16725052893161774, 0.16625410318374634, 0.16526150703430176, 0.16427278518676758, 0.1632879078388214, 0.16230687499046326, 0.1613297015428543, 0.16035637259483337, 0.15938690304756165, 0.15842127799987793, 0.15745951235294342, 0.15650157630443573, 0.15554749965667725, 0.15459725260734558, 0.15365086495876312, 0.15270830690860748, 0.15176959335803986, 0.15083472430706024, 0.14990368485450745, 0.14897648990154266, 0.1480531096458435, 0.14713357388973236, 0.14621786773204803, 0.14530597627162933, 0.14439791440963745, 0.1434936821460724, 0.14259324967861176, 0.14169666171073914, 0.14080387353897095, 0.1399148851633072, 0.13902971148490906, 0.13814835250377655, 0.13727077841758728, 0.13639700412750244, 0.13552704453468323, 0.13466085493564606, 0.13379846513271332, 0.13293986022472382, 0.13208504021167755, 0.13123399019241333, 0.13038671016693115, 0.12954320013523102, 0.12870346009731293, 0.12786747515201569, 0.1270352602005005, 0.12620678544044495, 0.12538206577301025, 0.12456108629703522, 0.12374383956193924, 0.12293034046888351, 0.12212056666612625, 0.12131451815366745, 0.12051218748092651, 0.11971357464790344, 0.11891866475343704, 0.11812746524810791, 0.11733996123075485, 0.11655615270137787, 0.11577603965997696, 0.11499959975481033, 0.11422684788703918, 0.11345776170492172, 0.11269234865903854, 0.11193060129880905, 0.11117249727249146, 0.11041805148124695, 0.10966724157333374, 0.10892007499933243, 0.10817653685808182, 0.10743661969900131, 0.10670032352209091, 0.10596764087677002, 0.10523856431245804, 0.10451308637857437, 0.10379119217395782, 0.10307289659976959, 0.10235816985368729, 0.1016470193862915, 0.10093943774700165, 0.10023541003465652, 0.09953493624925613, 0.09883800894021988, 0.09814461320638657, 0.0974547490477562, 0.09676840901374817, 0.09608558565378189, 0.09540626406669617, 0.094730444252491, 0.09405811876058578, 0.09338928014039993, 0.09272392094135284, 0.09206202626228333, 0.09140359610319138, 0.0907486230134964, 0.0900970920920372, 0.08944900333881378, 0.08880434185266495, 0.0881631001830101, 0.08752527832984924, 0.08689086139202118, 0.08625984191894531, 0.08563220500946045, 0.08500795811414719, 0.08438707888126373, 0.08376956731081009, 0.08315540105104446, 0.08254458755254745, 0.08193711936473846, 0.0813329741358757, 0.08073214441537857, 0.08013463765382767, 0.0795404314994812, 0.07894951105117798, 0.0783618837594986, 0.07777752727270126, 0.07719644159078598, 0.07661861181259155, 0.07604403048753738, 0.07547269016504288, 0.07490458339452744, 0.07433969527482986, 0.07377801835536957, 0.07321954518556595, 0.07266426831483841, 0.07211217284202576, 0.0715632513165474, 0.07101748883724213, 0.07047488540410995, 0.06993543356657028, 0.06939911097288132, 0.06886591762304306, 0.06833584606647491, 0.06780887395143509, 0.06728500127792358, 0.0667642131447792, 0.06624650955200195, 0.06573186814785004, 0.06522028148174286, 0.06471174210309982, 0.06420624256134033, 0.06370377540588379, 0.0632043182849884, 0.06270787119865417, 0.06221442297101021, 0.06172395870089531, 0.06123647093772888, 0.06075195223093033, 0.060270387679338455, 0.059791773557662964, 0.05931609496474266, 0.05884334072470665, 0.058373499661684036, 0.05790656432509422, 0.057442523539066315, 0.056981366127729416, 0.05652308091521263, 0.05606766417622566, 0.05561509355902672, 0.0551653653383255, 0.054718468338251114, 0.05427439138293266, 0.05383312702178955, 0.053394660353660583, 0.05295898765325546, 0.052526090294122696, 0.052095960825681686, 0.05166858807206154, 0.05124396085739136, 0.05082206800580025, 0.05040290206670761, 0.049986448138952255, 0.04957269877195358, 0.0491616427898407, 0.04875326529145241, 0.04834756255149841, 0.04794451966881752, 0.047544121742248535, 0.04714636504650116, 0.0467512384057045, 0.04635872691869736, 0.04596881940960884, 0.04558150842785835, 0.045196782797575, 0.04481462761759758, 0.044435035437345505, 0.044057998806238174, 0.0436834953725338, 0.043311525136232376, 0.04294207692146301, 0.042575132101774216, 0.04221068322658539, 0.041848719120025635, 0.04148923233151436, 0.041132211685180664, 0.04077764227986336, 0.040425512939691544, 0.04007581248879433, 0.03972853720188141, 0.0393836684525013, 0.039041195064783096, 0.03870110958814621, 0.03836340457201004, 0.038028061389923096, 0.03769507259130478, 0.037364427000284195, 0.03703611344099045, 0.03671012073755264, 0.036386437714099884, 0.036065056920051575, 0.03574596345424652, 0.03542914614081383, 0.0351145975291729, 0.03480230271816254, 0.03449225425720215, 0.03418443724513054, 0.03387884423136711, 0.03357546404004097, 0.03327428176999092, 0.03297528997063637, 0.03267848119139671, 0.032383836805820465, 0.032091353088617325, 0.0318010151386261, 0.03151281177997589, 0.031226731836795807, 0.03094276785850525, 0.030660904943943024, 0.030381137505173683, 0.030103450641036034, 0.02982783317565918, 0.029554277658462524, 0.029282771050930023, 0.02901330403983593, 0.0287458635866642, 0.028480442240834236, 0.028217025101184845, 0.02795560471713543, 0.027696168050169945, 0.027438707649707794, 0.027183210477232933, 0.026929667219519615, 0.026678064838051796, 0.02642839588224888, 0.026180649176239967, 0.025934811681509018, 0.025690875947475433, 0.025448830798268318, 0.025208663195371628, 0.024970365688204765, 0.024733927100896835, 0.024499336257576942, 0.02426658198237419, 0.024035654962062836, 0.02380654588341713, 0.023579243570566177, 0.023353736847639084, 0.023130014538764954, 0.02290807105600834, 0.022687891498208046, 0.022469468414783478, 0.02225278690457344, 0.022037843242287636, 0.02182462252676487, 0.021613115444779396, 0.021403314545750618, 0.02119520679116249, 0.02098878286778927, 0.020784035325050354, 0.020580951124429703, 0.02037951909005642, 0.020179733633995056, 0.01998157985508442, 0.01978505216538906, 0.019590137526392937, 0.01939682848751545, 0.019205115735530853, 0.019014986231923103, 0.018826432526111603, 0.018639443442225456, 0.018454011529684067, 0.01827012374997139, 0.01808777265250683, 0.017906948924064636, 0.017727641388773918, 0.017549842596054077, 0.017373541370034218, 0.017198728397488594, 0.01702539436519146, 0.01685352809727192, 0.016683124005794525, 0.016514169052243233, 0.016346657648682594, 0.016180574893951416, 0.0160159170627594, 0.0158526711165905, 0.01569082960486412, 0.01553038414567709, 0.015371323563158512, 0.01521364040672779, 0.01505732350051403, 0.014902365393936634, 0.014748756773769855, 0.014596487395465374, 0.014445550739765167, 0.014295936562120914, 0.014147634617984295, 0.014000637456774712, 0.013854935765266418, 0.013710521161556244, 0.013567385263741016, 0.013425517827272415, 0.013284911401569843, 0.013145556673407555, 0.013007445260882378, 0.012870567850768566, 0.012734917923808098, 0.012600484304130077, 0.012467259541153908, 0.012335236184298992, 0.01220440398901701, 0.012074755504727364, 0.011946282349526882, 0.011818977072834969, 0.011692829430103302, 0.011567831970751286, 0.011443977244198322, 0.011321255937218666, 0.01119966059923172, 0.011079182848334312, 0.010959814302623272, 0.010841546580195427, 0.01072437223047018, 0.010608283802866936, 0.010493272915482521, 0.010379331186413765, 0.010266452096402645, 0.010154626332223415, 0.010043846443295479, 0.009934104979038239, 0.009825393557548523, 0.009717704728245735, 0.009611031971871853, 0.00950536597520113, 0.009400700218975544, 0.009297026321291924, 0.009194337762892246, 0.009092627093195915, 0.008991885930299759, 0.00889210682362318, 0.008793283253908157, 0.008695406839251518, 0.008598471991717815, 0.008502470329403877, 0.008407393470406532, 0.008313236758112907, 0.008219990879297256, 0.008127650246024132, 0.008036206476390362, 0.007945653051137924, 0.007855983451008797, 0.00776719069108367, 0.007679267320781946, 0.007592206355184317, 0.007506001740694046, 0.00742064556106925, 0.007336131762713194, 0.0072524528950452805, 0.007169602904468775, 0.007087575271725655, 0.00700636301189661, 0.0069259596057236195, 0.00684635853394866, 0.006767552811652422, 0.006689536850899458, 0.006612303201109171, 0.0065358467400074005, 0.0064601595513522625, 0.006385236047208309, 0.006311069708317518, 0.006237654946744442, 0.006164984777569771, 0.006093052681535482, 0.006021853536367416, 0.005951380357146263, 0.005881628021597862, 0.005812589079141617, 0.005744258873164654, 0.005676630884408951, 0.005609698593616486, 0.005543456878513098, 0.005477899685502052, 0.005413020960986614, 0.0053488146513700485, 0.005285275634378195, 0.005222398322075605, 0.005160176195204258, 0.005098604131489992, 0.005037676077336073, 0.00497738691046834, 0.0049177310429513454, 0.0048587024211883545, 0.004800296388566494, 0.004742506425827742, 0.004685328342020512, 0.004628755617886782, 0.004572783596813679, 0.004517406690865755, 0.00446261977776885, 0.004408417735248804, 0.004354794975370169, 0.004301746375858784, 0.004249267280101776, 0.004197352100163698, 0.0041459957137703896, 0.004095193464308977, 0.004044939763844013, 0.003995229955762625, 0.003946059383451939, 0.0038974229246377945, 0.0038493156898766756, 0.0038017327897250652, 0.0037546695675700903, 0.003708121133968234, 0.00366208259947598, 0.003616549540311098, 0.003571517067030072, 0.0035269807558506727, 0.003482935717329383, 0.003439377760514617, 0.003396301995962858, 0.003353703999891877, 0.0033115793485194445, 0.0032699236180633307, 0.0032287323847413063, 0.0031880009919404984, 0.0031477254815399647, 0.003107901196926832, 0.003068524179980159, 0.0030295897740870714, 0.0029910942539572716, 0.00295303319580853, 0.002915402175858617, 0.0028781972359865904, 0.0028414144180715084, 0.002805049531161785, 0.0027690983843058348, 0.002733557252213359, 0.0026984219439327717, 0.0026636887341737747, 0.002629353664815426, 0.0025954123120754957, 0.002561861416324973, 0.002528697019442916, 0.002495915163308382, 0.002463512122631073, 0.0024314841721206903, 0.0023998278193175793, 0.0023685391061007977, 0.002337614307180047, 0.0023070501629263163, 0.0022768424823880196, 0.0022469882387667894, 0.0022174837067723274, 0.002188325161114335, 0.002159509342163801, 0.0021310329902917147, 0.0021028921473771334, 0.00207508378662169, 0.002047604415565729, 0.0020204505417495966, 0.0019936191383749247, 0.001967106945812702, 0.0019409102387726307, 0.0019150261068716645, 0.0018894511740654707, 0.0018641825299710035, 0.00183921679854393, 0.001814550836570561, 0.0017901816172525287, 0.001766105880960822, 0.0017423208337277174, 0.0017188232159242034, 0.0016956100007519126, 0.0016726783942431211, 0.0016500252531841397, 0.0016276477836072445, 0.0016055430751293898, 0.001583708100952208, 0.0015621401835232973, 0.00154083629604429, 0.0015197937609627843, 0.001499009900726378, 0.0014784816885367036, 0.001458206563256681, 0.0014381817309185863, 0.0014184046303853393, 0.0013988724676892161, 0.0013795825652778149, 0.0013605323620140553, 0.001341719296760857, 0.0013231406919658184, 0.0013047941029071808, 0.0012866770848631859, 0.0012687868438661098, 0.001251121168024838, 0.00123367749620229, 0.0012164533836767077, 0.0011994463857263327, 0.0011826540576294065};
constexpr float sigmas[1100] = {0.029167532920837402, 0.04131520166993141, 0.05068162456154823, 0.05861631780862808, 0.06564029306173325, 0.07202067971229553, 0.07791629433631897, 0.08343011885881424, 0.08863324671983719, 0.09357764571905136, 0.09830251336097717, 0.10283852368593216, 0.10720977932214737, 0.11143551766872406, 0.11553183197975159, 0.11951238662004471, 0.12338851392269135, 0.12716986238956451, 0.13086429238319397, 0.13447976112365723, 0.13802212476730347, 0.14149697124958038, 0.14490948617458344, 0.1482640653848648, 0.15156444907188416, 0.154814213514328, 0.15801694989204407, 0.1611749827861786, 0.1642913669347763, 0.16736851632595062, 0.1704084873199463, 0.17341329157352448, 0.17638501524925232, 0.17932520806789398, 0.1822356879711151, 0.18511773645877838, 0.187972754240036, 0.19080223143100739, 0.19360701739788055, 0.1963886022567749, 0.19914788007736206, 0.20188599824905396, 0.20460359752178192, 0.20730184018611908, 0.2099812924861908, 0.21264304220676422, 0.21528752148151398, 0.2179155796766281, 0.22052791714668274, 0.2231251448392868, 0.22570787370204926, 0.22827652096748352, 0.23083193600177765, 0.23337437212467194, 0.23590430617332458, 0.23842234909534454, 0.24092884361743927, 0.24342435598373413, 0.24590913951396942, 0.24838362634181976, 0.2508482038974762, 0.2533032298088074, 0.25574904680252075, 0.25818589329719543, 0.2606143355369568, 0.2630345821380615, 0.2654467821121216, 0.2678512632846832, 0.27024853229522705, 0.2726386487483978, 0.2750219702720642, 0.2773984968662262, 0.27976876497268677, 0.2821328639984131, 0.28449103236198425, 0.28684350848197937, 0.2891903519630432, 0.29153206944465637, 0.2938685715198517, 0.29620012640953064, 0.29852697253227234, 0.30084913969039917, 0.3031671345233917, 0.3054807484149933, 0.3077903091907501, 0.31009599566459656, 0.31239795684814453, 0.31469637155532837, 0.31699126958847046, 0.3192829191684723, 0.32157137989997864, 0.32385674118995667, 0.3261392116546631, 0.32841891050338745, 0.33069586753845215, 0.33297044038772583, 0.3352424204349518, 0.3375122845172882, 0.339779794216156, 0.3420453369617462, 0.3443087935447693, 0.34657052159309387, 0.3488304018974304, 0.35108867287635803, 0.3533453047275543, 0.3556004464626312, 0.35785433650016785, 0.36010682582855225, 0.36235812306404114, 0.36460837721824646, 0.36685752868652344, 0.36910584568977356, 0.37135326862335205, 0.37359994649887085, 0.3758458197116852, 0.3780912160873413, 0.38033607602119446, 0.38258039951324463, 0.38482433557510376, 0.3870679438114166, 0.38931146264076233, 0.39155471324920654, 0.3937978446483612, 0.39604103565216064, 0.3982841968536377, 0.4005275070667267, 0.40277090668678284, 0.4050145745277405, 0.40725862979888916, 0.40950289368629456, 0.4117475748062134, 0.41399288177490234, 0.4162386357784271, 0.4184850752353668, 0.42073214054107666, 0.4229799211025238, 0.42522838711738586, 0.42747771739959717, 0.4297279119491577, 0.43197908997535706, 0.4342312514781952, 0.4364843964576721, 0.4387386739253998, 0.44099414348602295, 0.44325074553489685, 0.4455086588859558, 0.44776788353919983, 0.4500284194946289, 0.4522903263568878, 0.45455366373062134, 0.45681852102279663, 0.4590849280357361, 0.4613529145717621, 0.4636225998401642, 0.46589386463165283, 0.46816688776016235, 0.47044163942337036, 0.4727182686328888, 0.4749966561794281, 0.47727707028388977, 0.4795592725276947, 0.4818435311317444, 0.48412981629371643, 0.48641830682754517, 0.4887087643146515, 0.4910013973712921, 0.493296355009079, 0.49559345841407776, 0.497892826795578, 0.5001944303512573, 0.5024985074996948, 0.5048050284385681, 0.5071138739585876, 0.5094252228736877, 0.5117390751838684, 0.5140555500984192, 0.5163745880126953, 0.5186961889266968, 0.5210204720497131, 0.5233475565910339, 0.5256772637367249, 0.528009831905365, 0.5303452610969543, 0.5326834917068481, 0.5350246429443359, 0.537368655204773, 0.5397157669067383, 0.5420657396316528, 0.5444188117980957, 0.5467749834060669, 0.5491342544555664, 0.551496684551239, 0.5538623332977295, 0.5562310814857483, 0.5586031675338745, 0.5609785914421082, 0.5633572340011597, 0.5657393336296082, 0.5681247711181641, 0.5705136060714722, 0.5729060173034668, 0.5753018260002136, 0.577701210975647, 0.5801042318344116, 0.5825108289718628, 0.5849209427833557, 0.5873348116874695, 0.5897524952888489, 0.5921738147735596, 0.5945988893508911, 0.5970277786254883, 0.5994605422019958, 0.6018972396850586, 0.604337751865387, 0.6067822575569153, 0.6092307567596436, 0.6116832494735718, 0.6141399145126343, 0.6166004538536072, 0.6190652251243591, 0.6215341091156006, 0.6240072250366211, 0.6264845728874207, 0.6289660930633545, 0.6314518451690674, 0.6339420676231384, 0.6364365816116333, 0.6389354467391968, 0.6414387822151184, 0.6439465880393982, 0.6464587450027466, 0.6489755511283875, 0.6514968872070312, 0.6540228128433228, 0.656553328037262, 0.6590885519981384, 0.6616283655166626, 0.6641730070114136, 0.666722297668457, 0.6692764759063721, 0.6718355417251587, 0.6743993759155273, 0.6769680380821228, 0.6795417070388794, 0.6821203231811523, 0.6847039461135864, 0.6872926354408264, 0.6898862719535828, 0.6924850940704346, 0.6950890421867371, 0.697698175907135, 0.7003124356269836, 0.7029320597648621, 0.7055568099021912, 0.70818692445755, 0.7108224630355835, 0.713463306427002, 0.716109573841095, 0.7187612056732178, 0.7214183211326599, 0.7240809798240662, 0.7267492413520813, 0.7294230461120605, 0.7321024537086487, 0.7347874641418457, 0.7374782562255859, 0.7401747703552246, 0.7428770661354065, 0.7455851435661316, 0.7482990622520447, 0.751018762588501, 0.7537444829940796, 0.756476104259491, 0.7592136859893799, 0.7619572877883911, 0.7647069096565247, 0.7674626708030701, 0.7702245116233826, 0.7729924917221069, 0.7757667303085327, 0.7785472273826599, 0.7813339829444885, 0.7841269969940186, 0.7869263887405396, 0.7897321581840515, 0.7925443649291992, 0.7953630089759827, 0.7981882095336914, 0.8010198473930359, 0.8038581609725952, 0.8067029714584351, 0.8095544576644897, 0.812412679195404, 0.8152776956558228, 0.8181493878364563, 0.8210278749465942, 0.8239132165908813, 0.8268055319786072, 0.8297046422958374, 0.8326107263565063, 0.8355239033699036, 0.8384441137313843, 0.8413713574409485, 0.8443057537078857, 0.8472473621368408, 0.850196123123169, 0.8531520962715149, 0.8561154007911682, 0.8590859770774841, 0.8620640635490417, 0.8650493025779724, 0.8680421710014343, 0.8710424900054932, 0.8740503787994385, 0.8770658373832703, 0.8800888061523438, 0.883119523525238, 0.8861580491065979, 0.8892041444778442, 0.8922581672668457, 0.895319938659668, 0.8983896374702454, 0.9014672040939331, 0.9045528173446655, 0.9076463580131531, 0.9107480049133301, 0.9138576984405518, 0.9169756174087524, 0.9201016426086426, 0.9232358932495117, 0.9263784289360046, 0.9295293092727661, 0.9326885342597961, 0.935856282711029, 0.9390323162078857, 0.9422169327735901, 0.9454100728034973, 0.9486119151115417, 0.9518222212791443, 0.9550414085388184, 0.9582692980766296, 0.9615059494972229, 0.9647513628005981, 0.9680056571960449, 0.9712689518928528, 0.9745412468910217, 0.9778226017951965, 0.9811129570007324, 0.984412431716919, 0.9877211451530457, 0.991038978099823, 0.9943662881851196, 0.9977027177810669, 1.0010486841201782, 1.0044039487838745, 1.0077687501907349, 1.0111430883407593, 1.0145269632339478, 1.0179206132888794, 1.021323800086975, 1.024736762046814, 1.028159499168396, 1.0315921306610107, 1.0350345373153687, 1.0384870767593384, 1.0419496297836304, 1.045422077178955, 1.0489046573638916, 1.0523974895477295, 1.0559004545211792, 1.0594137907028198, 1.0629373788833618, 1.0664714574813843, 1.0700159072875977, 1.0735708475112915, 1.0771363973617554, 1.0807125568389893, 1.0842993259429932, 1.0878968238830566, 1.0915050506591797, 1.0951242446899414, 1.0987544059753418, 1.1023954153060913, 1.1060473918914795, 1.109710454940796, 1.1133848428726196, 1.117070198059082, 1.1207669973373413, 1.1244750022888184, 1.1281943321228027, 1.131925344467163, 1.1356675624847412, 1.1394215822219849, 1.143187165260315, 1.1469643115997314, 1.150753378868103, 1.1545543670654297, 1.1583670377731323, 1.16219162940979, 1.166028380393982, 1.169877052307129, 1.1737380027770996, 1.1776111125946045, 1.181496500968933, 1.185394287109375, 1.1893044710159302, 1.193226933479309, 1.19716215133667, 1.2011098861694336, 1.2050703763961792, 1.2090435028076172, 1.2130295038223267, 1.2170283794403076, 1.22104012966156, 1.2250651121139526, 1.2291030883789062, 1.2331541776657104, 1.2372186183929443, 1.2412962913513184, 1.245387315750122, 1.2494919300079346, 1.2536098957061768, 1.2577415704727173, 1.2618869543075562, 1.2660460472106934, 1.270218849182129, 1.2744057178497314, 1.2786065340042114, 1.2828214168548584, 1.2870503664016724, 1.2912935018539429, 1.2955509424209595, 1.2998228073120117, 1.3041090965270996, 1.3084099292755127, 1.312725305557251, 1.3170554637908936, 1.3214001655578613, 1.325759768486023, 1.3301345109939575, 1.334524154663086, 1.3389288187026978, 1.3433486223220825, 1.3477838039398193, 1.3522342443466187, 1.35670006275177, 1.3611814975738525, 1.365678310394287, 1.3701910972595215, 1.374719500541687, 1.3792637586593628, 1.3838239908218384, 1.3884000778198242, 1.392992377281189, 1.3976010084152222, 1.4022258520126343, 1.4068670272827148, 1.411524772644043, 1.4161988496780396, 1.4208898544311523, 1.4255974292755127, 1.4303220510482788, 1.4350636005401611, 1.4398219585418701, 1.444597601890564, 1.4493904113769531, 1.4542005062103271, 1.4590281248092651, 1.463873267173767, 1.4687358140945435, 1.473616123199463, 1.478514313697815, 1.4834303855895996, 1.488364338874817, 1.4933165311813354, 1.4982869625091553, 1.5032755136489868, 1.5082826614379883, 1.5133081674575806, 1.5183523893356323, 1.5234153270721436, 1.5284970998764038, 1.533597707748413, 1.53871750831604, 1.5438563823699951, 1.5490144491195679, 1.5541919469833374, 1.5593888759613037, 1.5646053552627563, 1.569841742515564, 1.5750975608825684, 1.5803736448287964, 1.5856695175170898, 1.590985655784607, 1.596321940422058, 1.601678490638733, 1.6070556640625, 1.6124534606933594, 1.6178721189498901, 1.6233114004135132, 1.6287716627120972, 1.6342531442642212, 1.6397556066513062, 1.6452794075012207, 1.650824785232544, 1.6563917398452759, 1.6619802713394165, 1.667590618133545, 1.6732227802276611, 1.6788772344589233, 1.684553623199463, 1.690252423286438, 1.6959736347198486, 1.701717495918274, 1.7074840068817139, 1.713273286819458, 1.7190855741500854, 1.7249208688735962, 1.7307794094085693, 1.7366613149642944, 1.742566704750061, 1.7484956979751587, 1.7544485330581665, 1.7604252099990845, 1.7664259672164917, 1.7724508047103882, 1.7785000801086426, 1.7845736742019653, 1.790671944618225, 1.7967950105667114, 1.8029427528381348, 1.8091156482696533, 1.8153138160705566, 1.8215371370315552, 1.8277859687805176, 1.8340604305267334, 1.8403607606887817, 1.846686840057373, 1.853039026260376, 1.8594175577163696, 1.8658223152160645, 1.8722537755966187, 1.8787118196487427, 1.885196566581726, 1.891708493232727, 1.898247480392456, 1.9048138856887817, 1.911407709121704, 1.9180291891098022, 1.9246783256530762, 1.9313554763793945, 1.9380608797073364, 1.9447945356369019, 1.9515565633773804, 1.9583474397659302, 1.9651669263839722, 1.9720155000686646, 1.9788931608200073, 1.98580002784729, 1.9927364587783813, 1.9997025728225708, 2.0066986083984375, 2.0137245655059814, 2.0207808017730713, 2.027867317199707, 2.0349843502044678, 2.0421321392059326, 2.0493109226226807, 2.056520938873291, 2.0637619495391846, 2.0710346698760986, 2.078339099884033, 2.0856752395629883, 2.093043565750122, 2.1004440784454346, 2.107877016067505, 2.115342617034912, 2.1228411197662354, 2.1303722858428955, 2.137937068939209, 2.1455352306365967, 2.1531670093536377, 2.160832405090332, 2.168532133102417, 2.1762659549713135, 2.1840343475341797, 2.1918373107910156, 2.1996750831604004, 2.207548141479492, 2.215456247329712, 2.223400115966797, 2.231379508972168, 2.2393949031829834, 2.2474465370178223, 2.2555344104766846, 2.2636590003967285, 2.271820545196533, 2.2800190448760986, 2.288254737854004, 2.2965281009674072, 2.3048391342163086, 2.313188076019287, 2.321575403213501, 2.330000877380371, 2.3384652137756348, 2.346968412399292, 2.355510950088501, 2.3640928268432617, 2.3727142810821533, 2.381375789642334, 2.3900771141052246, 2.3988189697265625, 2.4076015949249268, 2.4164249897003174, 2.4252893924713135, 2.4341955184936523, 2.443143129348755, 2.4521327018737793, 2.4611642360687256, 2.470238447189331, 2.4793553352355957, 2.4885151386260986, 2.49771785736084, 2.506964683532715, 2.5162549018859863, 2.5255894660949707, 2.534968137741089, 2.544391393661499, 2.5538594722747803, 2.563372850418091, 2.5729315280914307, 2.582536220550537, 2.59218692779541, 2.60188364982605, 2.6116273403167725, 2.62141752243042, 2.6312553882598877, 2.6411402225494385, 2.6510732173919678, 2.6610543727874756, 2.671083688735962, 2.681161880493164, 2.691288948059082, 2.701465606689453, 2.7116916179656982, 2.721967935562134, 2.7322943210601807, 2.742671251296997, 2.753099203109741, 2.763578414916992, 2.774109363555908, 2.7846920490264893, 2.7953269481658936, 2.8060142993927, 2.8167548179626465, 2.8275485038757324, 2.838395595550537, 2.849297046661377, 2.8602523803710938, 2.871262550354004, 2.8823277950286865, 2.8934481143951416, 2.9046244621276855, 2.9158565998077393, 2.92714524269104, 2.938491106033325, 2.9498934745788574, 2.9613537788391113, 2.972871780395508, 2.984447956085205, 2.9960832595825195, 3.007777214050293, 3.0195305347442627, 3.031344175338745, 3.043217658996582, 3.0551514625549316, 3.0671465396881104, 3.0792031288146973, 3.0913214683532715, 3.103502035140991, 3.1157450675964355, 3.1280510425567627, 3.14042067527771, 3.1528539657592773, 3.165351629257202, 3.1779139041900635, 3.1905415058135986, 3.2032344341278076, 3.2159934043884277, 3.228818893432617, 3.241710901260376, 3.2546706199645996, 3.267698049545288, 3.2807931900024414, 3.293957471847534, 3.3071906566619873, 3.320493459701538, 3.3338663578033447, 3.3473093509674072, 3.3608238697052, 3.3744094371795654, 3.3880670070648193, 3.40179705619812, 3.415599822998047, 3.429476261138916, 3.4434263706207275, 3.4574506282806396, 3.4715499877929688, 3.485724687576294, 3.4999749660491943, 3.5143020153045654, 3.528705596923828, 3.543186664581299, 3.557745933532715, 3.572383165359497, 3.587099552154541, 3.601895809173584, 3.616771936416626, 3.6317286491394043, 3.646766185760498, 3.6618857383728027, 3.6770873069763184, 3.6923716068267822, 3.7077395915985107, 3.723191261291504, 3.738727569580078, 3.7543487548828125, 3.7700557708740234, 3.785849094390869, 3.801729440689087, 3.817697048187256, 3.833752393722534, 3.8498966693878174, 3.8661298751831055, 3.882453203201294, 3.898867130279541, 3.915371894836426, 3.9319684505462646, 3.948657512664795, 3.9654393196105957, 3.9823148250579834, 3.999284505844116, 4.0163493156433105, 4.033509731292725, 4.0507659912109375, 4.068119525909424, 4.085570335388184, 4.103119850158691, 4.120768070220947, 4.138515949249268, 4.156364440917969, 4.174314022064209, 4.192364692687988, 4.2105183601379395, 4.228774547576904, 4.247135162353516, 4.265600204467773, 4.284170627593994, 4.302847385406494, 4.321630477905273, 4.340521812438965, 4.35952091217041, 4.378629207611084, 4.3978471755981445, 4.417176246643066, 4.43661642074585, 4.4561686515808105, 4.475834369659424, 4.4956135749816895, 4.515507221221924, 4.535516738891602, 4.555642127990723, 4.575884819030762, 4.596245288848877, 4.616724014282227, 4.637322902679443, 4.658041954040527, 4.678882598876953, 4.699844837188721, 4.720930576324463, 4.74213981628418, 4.763473987579346, 4.784934043884277, 4.806520462036133, 4.8282341957092285, 4.850076675415039, 4.8720479011535645, 4.894150257110596, 4.916383266448975, 4.938748359680176, 4.961246967315674, 4.983879089355469, 5.006646633148193, 5.029549598693848, 5.052590370178223, 5.07576847076416, 5.099085330963135, 5.122542858123779, 5.146141052246094, 5.169881343841553, 5.1937642097473145, 5.217791557312012, 5.241963863372803, 5.266282558441162, 5.290748119354248, 5.315362453460693, 5.340126037597656, 5.365039825439453, 5.390105724334717, 5.4153242111206055, 5.4406962394714355, 5.46622371673584, 5.491907119750977, 5.517747402191162, 5.543746471405029, 5.5699052810668945, 5.596224308013916, 5.622705936431885, 5.649350166320801, 5.676159381866455, 5.703133583068848, 5.7302751541137695, 5.757584095001221, 5.785062313079834, 5.812711238861084, 5.840531826019287, 5.868525981903076, 5.896694183349609, 5.925037860870361, 5.953558921813965, 5.982257843017578, 6.011137008666992, 6.040196895599365, 6.069438934326172, 6.098864555358887, 6.128475666046143, 6.158272743225098, 6.188258171081543, 6.218432426452637, 6.248797416687012, 6.279355049133301, 6.310105800628662, 6.3410515785217285, 6.372194290161133, 6.403534412384033, 6.435074329376221, 6.466814994812012, 6.498758792877197, 6.5309062004089355, 6.563259601593018, 6.595819473266602, 6.628588676452637, 6.6615681648254395, 6.694759845733643, 6.728165149688721, 6.76178503036499, 6.795621871948242, 6.829677581787109, 6.863953113555908, 6.8984503746032715, 6.93317174911499, 6.968118190765381, 7.003291606903076, 7.038693904876709, 7.074326515197754, 7.110191345214844, 7.146290302276611, 7.182624340057373, 7.2191972732543945, 7.256009101867676, 7.293062210083008, 7.330358982086182, 7.36790132522583, 7.405689716339111, 7.443727970123291, 7.482016086578369, 7.520557880401611, 7.559353828430176, 7.59840726852417, 7.637719631195068, 7.677292346954346, 7.717127799987793, 7.757227897644043, 7.797595977783203, 7.838232517242432, 7.879140377044678, 7.920321464538574, 7.961778163909912, 8.003512382507324, 8.045525550842285, 8.087821960449219, 8.130402565002441, 8.17326831817627, 8.216424942016602, 8.259871482849121, 8.303609848022461, 8.34764575958252, 8.391979217529297, 8.436613082885742, 8.481550216674805, 8.5267915725708, 8.572340965270996, 8.618200302124023, 8.664371490478516, 8.710857391357422, 8.757661819458008, 8.804786682128906, 8.852232933044434, 8.900005340576172, 8.948104858398438, 8.99653434753418, 9.045297622680664, 9.094396591186523, 9.14383316040039, 9.193612098693848, 9.243734359741211, 9.29420280456543, 9.34502124786377, 9.396191596984863, 9.447717666625977, 9.499601364135742, 9.55184555053711, 9.60445499420166, 9.657430648803711, 9.710774421691895, 9.764492988586426, 9.818586349487305, 9.873058319091797, 9.927912712097168, 9.983152389526367, 10.038779258728027, 10.094799041748047, 10.151211738586426, 10.208023071289062, 10.26523494720459, 10.32285213470459, 10.380876541137695, 10.439311027526855, 10.498160362243652, 10.557428359985352, 10.61711597442627, 10.677229881286621, 10.737771034240723, 10.798744201660156, 10.860153198242188, 10.92199993133545, 10.98429012298584, 11.047026634216309, 11.110212326049805, 11.173852920532227, 11.23794937133789, 11.302507400512695, 11.367530822753906, 11.433023452758789, 11.498987197875977, 11.5654296875, 11.632351875305176, 11.699760437011719, 11.767656326293945, 11.83604621887207, 11.904932022094727, 11.974319458007812, 12.044212341308594, 12.114615440368652, 12.185531616210938, 12.256966590881348, 12.328924179077148, 12.401409149169922, 12.474425315856934, 12.547978401184082, 12.6220703125, 12.696708679199219, 12.771897315979004, 12.847639083862305, 12.923940658569336, 13.000805854797363, 13.078240394592285, 13.156248092651367, 13.234833717346191, 13.314003944396973, 13.39376163482666, 13.474112510681152, 13.555063247680664, 13.636616706848145, 13.718778610229492, 13.801554679870605, 13.884949684143066, 13.968969345092773, 14.053619384765625, 14.138904571533203, 14.224830627441406, 14.311403274536133, 14.398627281188965, 14.486509323120117, 14.575054168701172, 14.66426944732666, 14.754158020019531, 14.844727516174316, 14.935983657836914, 15.027933120727539, 15.120579719543457, 15.213932037353516, 15.30799388885498, 15.4027738571167, 15.498276710510254, 15.59450912475586, 15.69147777557373, 15.789188385009766, 15.887648582458496, 15.986863136291504, 16.08683967590332, 16.187585830688477, 16.289108276367188, 16.39141082763672, 16.494504928588867, 16.598392486572266, 16.70308494567871, 16.8085880279541, 16.914907455444336, 17.022052764892578, 17.130029678344727, 17.23884391784668, 17.348508834838867, 17.45902442932129, 17.570404052734375, 17.68265151977539, 17.795778274536133, 17.9097900390625, 18.02469253540039, 18.140499114990234, 18.257211685180664, 18.37484359741211, 18.49340057373047, 18.612890243530273, 18.73332405090332, 18.854705810546875, 18.977048873901367, 19.100358963012695, 19.224645614624023, 19.349916458129883, 19.476181030273438, 19.60344886779785, 19.73172950744629, 19.861032485961914, 19.991363525390625, 20.12273597717285, 20.255157470703125, 20.38863754272461, 20.5231876373291, 20.6588134765625, 20.7955265045166, 20.933340072631836, 21.0722599029541, 21.212299346923828, 21.353466033935547, 21.495769500732422, 21.639223098754883, 21.783836364746094, 21.92962074279785, 22.076583862304688, 22.224740982055664, 22.374099731445312, 22.524669647216797, 22.676467895507812, 22.829500198364258, 22.983781814575195, 23.139320373535156, 23.296131134033203, 23.4542236328125, 23.613609313964844, 23.774303436279297, 23.93631362915039, 24.099655151367188, 24.264341354370117, 24.430381774902344, 24.59779167175293, 24.76658058166504, 24.936763763427734, 25.108354568481445, 25.28136444091797, 25.455808639526367, 25.631698608398438, 25.809049606323242, 25.987873077392578, 26.168184280395508, 26.349998474121094, 26.533327102661133, 26.718185424804688, 26.90458869934082, 27.092552185058594, 27.282089233398438, 27.473215103149414, 27.665943145751953, 27.86029052734375, 28.056272506713867, 28.253904342651367, 28.45319938659668, 28.654176712036133, 28.856853485107422, 29.061241149902344 };
constexpr float log_sigmas[1100] = {-3.534698963165283, -3.1865248680114746, -2.982191801071167, -2.8367421627044678, -2.7235655784606934, -2.6308019161224365, -2.5521202087402344, -2.48374605178833, -2.423248291015625, -2.3689637184143066, -2.3197057247161865, -2.274595260620117, -2.2329678535461426, -2.1943092346191406, -2.1582090854644775, -2.124335289001465, -2.0924172401428223, -2.0622315406799316, -2.0335943698883057, -2.0063414573669434, -1.9803413152694702, -1.955476999282837, -1.9316459894180298, -1.9087603092193604, -1.8867443799972534, -1.8655295372009277, -1.84505295753479, -1.8252646923065186, -1.806113839149475, -1.7875572443008423, -1.7695568799972534, -1.752077579498291, -1.7350860834121704, -1.7185543775558472, -1.7024544477462769, -1.6867632865905762, -1.6714582443237305, -1.6565178632736206, -1.6419248580932617, -1.6276599168777466, -1.6137075424194336, -1.6000521183013916, -1.5866808891296387, -1.5735794305801392, -1.560736894607544, -1.5481404066085815, -1.5357807874679565, -1.5236475467681885, -1.5117310285568237, -1.500022530555725, -1.488513708114624, -1.477197527885437, -1.4660654067993164, -1.4551113843917847, -1.444329023361206, -1.4337116479873657, -1.4232536554336548, -1.4129490852355957, -1.4027931690216064, -1.3927809000015259, -1.3829072713851929, -1.3731679916381836, -1.3635586500167847, -1.3540754318237305, -1.344713568687439, -1.3354697227478027, -1.326340913772583, -1.3173234462738037, -1.3084132671356201, -1.2996079921722412, -1.2909042835235596, -1.2823002338409424, -1.2737919092178345, -1.265377163887024, -1.2570536136627197, -1.2488185167312622, -1.2406702041625977, -1.232605218887329, -1.2246226072311401, -1.2167199850082397, -1.208894968032837, -1.2011463642120361, -1.193471074104309, -1.185868501663208, -1.178336501121521, -1.1708734035491943, -1.1634774208068848, -1.1561470031738281, -1.1488810777664185, -1.141677737236023, -1.134535789489746, -1.1274540424346924, -1.1204309463500977, -1.1134653091430664, -1.1065561771392822, -1.0997016429901123, -1.092901349067688, -1.0861533880233765, -1.0794575214385986, -1.0728119611740112, -1.0662163496017456, -1.059669017791748, -1.0531693696975708, -1.0467164516448975, -1.0403094291687012, -1.033947467803955, -1.0276292562484741, -1.0213545560836792, -1.0151222944259644, -1.0089313983917236, -1.0027817487716675, -0.9966718554496765, -0.9906014204025269, -0.984569787979126, -0.9785763025283813, -0.9726197719573975, -0.9667000770568848, -0.960816502571106, -0.9549683332443237, -0.9491550326347351, -0.9433755278587341, -0.9376299977302551, -0.9319175481796265, -0.9262374639511108, -0.9205895066261292, -0.9149728417396545, -0.9093873500823975, -0.903832197189331, -0.8983068466186523, -0.8928112983703613, -0.8873448371887207, -0.8819065093994141, -0.8764965534210205, -0.8711140751838684, -0.8657588958740234, -0.8604305982589722, -0.8551288843154907, -0.8498530983924866, -0.8446030616760254, -0.8393781185150146, -0.83417809009552, -0.8290026783943176, -0.8238513469696045, -0.8187236785888672, -0.8136196136474609, -0.8085386157035828, -0.8034802675247192, -0.7984445691108704, -0.7934309840202332, -0.7884392738342285, -0.7834690809249878, -0.7785200476646423, -0.7735919952392578, -0.768684446811676, -0.763797402381897, -0.7589304447174072, -0.7540833950042725, -0.7492557168006897, -0.7444475293159485, -0.7396581172943115, -0.7348877787590027, -0.7301358580589294, -0.7254021763801575, -0.7206863164901733, -0.7159885168075562, -0.7113083004951477, -0.7066451907157898, -0.701999306678772, -0.6973704099655151, -0.6927583813667297, -0.688162624835968, -0.6835830211639404, -0.6790196895599365, -0.6744722127914429, -0.6699404120445251, -0.6654239296913147, -0.6609228253364563, -0.6564369201660156, -0.6519659161567688, -0.6475095152854919, -0.6430678367614746, -0.6386404037475586, -0.6342270374298096, -0.6298278570175171, -0.6254425048828125, -0.621070921421051, -0.6167126297950745, -0.6123679876327515, -0.608036458492279, -0.6037179231643677, -0.5994123220443726, -0.5951194763183594, -0.590839147567749, -0.586571455001831, -0.582315981388092, -0.5780725479125977, -0.5738413333892822, -0.5696218609809875, -0.5654141902923584, -0.56121826171875, -0.5570335984230042, -0.5528604388237, -0.5486984848976135, -0.5445474982261658, -0.5404075384140015, -0.5362786054611206, -0.532160222530365, -0.5280523300170898, -0.5239551067352295, -0.5198682546615601, -0.515791654586792, -0.511725127696991, -0.5076685547828674, -0.5036220550537109, -0.49958527088165283, -0.4955582022666931, -0.49154070019721985, -0.48753249645233154, -0.483534038066864, -0.47954463958740234, -0.47556447982788086, -0.47159332036972046, -0.46763113141059875, -0.46367794275283813, -0.45973360538482666, -0.4557977318763733, -0.45187050104141235, -0.4479518532752991, -0.44404155015945435, -0.4401395320892334, -0.4362458884716034, -0.4323602020740509, -0.42848268151283264, -0.42461302876472473, -0.4207513630390167, -0.41689741611480713, -0.4130512773990631, -0.4092126190662384, -0.4053816795349121, -0.4015580117702484, -0.39774173498153687, -0.3939328193664551, -0.3901312053203583, -0.38633668422698975, -0.3825491964817047, -0.3787687420845032, -0.3749951124191284, -0.37122851610183716, -0.36746856570243835, -0.3637153208255768, -0.3599686920642853, -0.35622870922088623, -0.352495014667511, -0.3487679660320282, -0.3450472354888916, -0.3413325548171997, -0.3376242518424988, -0.33392205834388733, -0.3302260637283325, -0.3265361189842224, -0.3228520452976227, -0.31917375326156616, -0.3155014216899872, -0.3118348717689514, -0.3081739544868469, -0.3045186698436737, -0.3008689284324646, -0.29722467064857483, -0.29358595609664917, -0.2899526059627533, -0.2863246500492096, -0.28270187973976135, -0.27908432483673096, -0.2754719853401184, -0.27186480164527893, -0.268262654542923, -0.2646654546260834, -0.2610732614994049, -0.257485955953598, -0.25390341877937317, -0.25032562017440796, -0.2467525750398636, -0.24318429827690125, -0.23962056636810303, -0.2360614687204361, -0.23250678181648254, -0.22895662486553192, -0.22541086375713348, -0.2218695431947708, -0.2183324694633484, -0.21479974687099457, -0.2112712413072586, -0.20774686336517334, -0.20422647893428802, -0.20071034133434296, -0.19719822704792023, -0.19369007647037506, -0.1901857554912567, -0.1866855025291443, -0.18318906426429749, -0.17969632148742676, -0.17620733380317688, -0.17272216081619263, -0.1692405641078949, -0.16576258838176727, -0.16228821873664856, -0.15881744027137756, -0.15535008907318115, -0.15188626945018768, -0.14842569828033447, -0.14496879279613495, -0.14151497185230255, -0.13806451857089996, -0.13461725413799286, -0.13117322325706482, -0.12773245573043823, -0.12429472804069519, -0.12085996568202972, -0.11742843687534332, -0.11399975419044495, -0.1105741560459137, -0.10715141147375107, -0.10373162478208542, -0.10031458735466003, -0.09690044075250626, -0.09348902851343155, -0.09008041024208069, -0.08667439222335815, -0.08327113837003708, -0.07987049967050552, -0.0764724612236023, -0.07307694107294083, -0.0696839690208435, -0.06629335880279541, -0.06290538609027863, -0.05951973795890808, -0.05613650009036064, -0.052755504846572876, -0.04937700182199478, -0.04600058123469353, -0.042626433074474335, -0.039254527539014816, -0.03588486462831497, -0.03251734748482704, -0.02915186434984207, -0.025788433849811554, -0.022427013143897057, -0.019067680463194847, -0.01571033149957657, -0.012354862876236439, -0.009001413360238075, -0.005649641156196594, -0.002299924846738577, 0.0010481347562745214, 0.004394279792904854, 0.007738729473203421, 0.011081461794674397, 0.014422459527850151, 0.01776193268597126, 0.021099630743265152, 0.02443576231598854, 0.027770310640335083, 0.03110336698591709, 0.03443479537963867, 0.03776492178440094, 0.0410936065018177, 0.04442070052027702, 0.0477464385330677, 0.051070887595415115, 0.054393913596868515, 0.057715725153684616, 0.061036188155412674, 0.06435549259185791, 0.06767351180315018, 0.07099033147096634, 0.07430603355169296, 0.07762059569358826, 0.08093399554491043, 0.08424631506204605, 0.08755753189325333, 0.09086782485246658, 0.09417717903852463, 0.09748546779155731, 0.10079275816679001, 0.10409912467002869, 0.10740479081869125, 0.11070936918258667, 0.11401326209306717, 0.11731625348329544, 0.12061841785907745, 0.1239200308918953, 0.12722063064575195, 0.1305207461118698, 0.13382011651992798, 0.13711872696876526, 0.14041683077812195, 0.14371444284915924, 0.14701128005981445, 0.1503075659275055, 0.1536034345626831, 0.15689866244792938, 0.160193532705307, 0.16348791122436523, 0.16678185760974884, 0.1700754463672638, 0.1733686476945877, 0.17666134238243103, 0.17995387315750122, 0.18324603140354156, 0.1865379810333252, 0.18982954323291779, 0.19312095642089844, 0.19641214609146118, 0.19970305263996124, 0.2029939889907837, 0.20628470182418823, 0.20957525074481964, 0.21286579966545105, 0.2161562442779541, 0.2194465845823288, 0.22273701429367065, 0.22602730989456177, 0.22931769490242004, 0.23260818421840668, 0.2358987033367157, 0.23918920755386353, 0.24247996509075165, 0.24577082693576813, 0.24906186759471893, 0.2523530423641205, 0.25564444065093994, 0.2589360177516937, 0.26222795248031616, 0.2655201256275177, 0.2688125967979431, 0.27210533618927, 0.2753985524177551, 0.2786918878555298, 0.28198570013046265, 0.2852800786495209, 0.28857478499412537, 0.2918699085712433, 0.295165479183197, 0.2984616160392761, 0.3017582297325134, 0.30505529046058655, 0.3083530366420746, 0.3116512596607208, 0.31495025753974915, 0.31824973225593567, 0.3215498626232147, 0.3248507082462311, 0.328152060508728, 0.33145424723625183, 0.3347572088241577, 0.3380608558654785, 0.341365247964859, 0.34467050433158875, 0.347976416349411, 0.35128331184387207, 0.3545910120010376, 0.35789960622787476, 0.36120912432670593, 0.3645194172859192, 0.3678308129310608, 0.37114304304122925, 0.3744562566280365, 0.3777705132961273, 0.3810858726501465, 0.3844020962715149, 0.3877193331718445, 0.3910377323627472, 0.39435723423957825, 0.39767777919769287, 0.4009994864463806, 0.40432244539260864, 0.40764638781547546, 0.4109717011451721, 0.41429808735847473, 0.4176257848739624, 0.42095473408699036, 0.42428499460220337, 0.4276164174079895, 0.43094930052757263, 0.43428343534469604, 0.4376189112663269, 0.44095578789711, 0.4442939758300781, 0.44763362407684326, 0.4509747624397278, 0.45431721210479736, 0.45766130089759827, 0.46100670099258423, 0.4643537402153015, 0.4677022099494934, 0.4710521399974823, 0.4744037091732025, 0.47775691747665405, 0.4811117649078369, 0.48446816205978394, 0.4878261387348175, 0.49118590354919434, 0.49454718828201294, 0.49791020154953003, 0.5012750625610352, 0.504641592502594, 0.5080097913742065, 0.5113798379898071, 0.5147515535354614, 0.5181252360343933, 0.5215005874633789, 0.5248779058456421, 0.5282570123672485, 0.5316380262374878, 0.5350209474563599, 0.5384057760238647, 0.5417925119400024, 0.545181155204773, 0.5485718250274658, 0.551964521408081, 0.5553591251373291, 0.5587558150291443, 0.5621545910835266, 0.5655553936958313, 0.5689582824707031, 0.5723631978034973, 0.575770378112793, 0.5791795253753662, 0.5825909376144409, 0.5860044956207275, 0.5894201993942261, 0.5928381681442261, 0.5962583422660828, 0.5996807217597961, 0.603105366230011, 0.6065323352813721, 0.6099616289138794, 0.6133931279182434, 0.6168270111083984, 0.6202632784843445, 0.6237018704414368, 0.6271429061889648, 0.6305863261222839, 0.6340320706367493, 0.6374803781509399, 0.6409310698509216, 0.6443843245506287, 0.6478400230407715, 0.6512982249259949, 0.654758870601654, 0.6582220792770386, 0.6616879105567932, 0.665156364440918, 0.6686273217201233, 0.6721009612083435, 0.6755771636962891, 0.6790561079978943, 0.6825376749038696, 0.6860218644142151, 0.6895087957382202, 0.692998468875885, 0.6964908838272095, 0.6999860405921936, 0.7034839987754822, 0.7069846391677856, 0.7104881405830383, 0.7139944434165955, 0.7175036072731018, 0.7210156917572021, 0.7245305180549622, 0.7280483245849609, 0.7315690517425537, 0.7350926399230957, 0.7386192679405212, 0.7421488165855408, 0.7456812858581543, 0.7492167949676514, 0.752755343914032, 0.7562967538833618, 0.7598413825035095, 0.7633890509605408, 0.7669397592544556, 0.7704935073852539, 0.7740505337715149, 0.7776105403900146, 0.7811737656593323, 0.784740149974823, 0.7883096933364868, 0.7918824553489685, 0.7954583764076233, 0.7990375757217407, 0.802619993686676, 0.806205689907074, 0.8097947239875793, 0.8133869171142578, 0.8169825077056885, 0.8205814957618713, 0.8241838216781616, 0.8277894258499146, 0.8313984870910645, 0.8350108861923218, 0.8386266827583313, 0.8422459959983826, 0.8458686470985413, 0.8494948148727417, 0.8531244993209839, 0.856757640838623, 0.8603943586349487, 0.8640345931053162, 0.8676784038543701, 0.8713256120681763, 0.8749765157699585, 0.878631055355072, 0.8822891712188721, 0.8859508633613586, 0.8896163105964661, 0.8932853937149048, 0.8969581127166748, 0.9006345272064209, 0.9043146967887878, 0.9079985618591309, 0.9116861820220947, 0.9153774976730347, 0.9190727472305298, 0.9227716326713562, 0.9264744520187378, 0.9301810264587402, 0.9338914752006531, 0.9376057386398315, 0.9413238763809204, 0.9450459480285645, 0.9487719535827637, 0.9525018930435181, 0.9562356472015381, 0.9599735736846924, 0.9637151956558228, 0.9674610495567322, 0.9712107181549072, 0.9749645590782166, 0.9787224531173706, 0.9824842214584351, 0.9862502813339233, 0.9900202751159668, 0.9937944412231445, 0.997572660446167, 1.0013551712036133, 1.0051416158676147, 1.00893235206604, 1.0127272605895996, 1.0165263414382935, 1.0203297138214111, 1.024137258529663, 1.0279490947723389, 1.031765103340149, 1.0355854034423828, 1.03941011428833, 1.0432389974594116, 1.0470722913742065, 1.0509098768234253, 1.0547518730163574, 1.058598279953003, 1.0624489784240723, 1.0663042068481445, 1.070163607597351, 1.07402765750885, 1.077896237373352, 1.0817689895629883, 1.0856465101242065, 1.0895284414291382, 1.0934147834777832, 1.0973057746887207, 1.1012012958526611, 1.1051013469696045, 1.1090061664581299, 1.1129153966903687, 1.1168291568756104, 1.120747685432434, 1.1246708631515503, 1.128598690032959, 1.1325311660766602, 1.1364682912826538, 1.1404101848602295, 1.1443567276000977, 1.1483080387115479, 1.15226411819458, 1.1562249660491943, 1.1601907014846802, 1.1641610860824585, 1.1681363582611084, 1.1721163988113403, 1.1761012077331543, 1.180091142654419, 1.1840858459472656, 1.1880851984024048, 1.1920896768569946, 1.196099042892456, 1.2001134157180786, 1.2041326761245728, 1.2081568241119385, 1.2121860980987549, 1.2162203788757324, 1.2202595472335815, 1.2243038415908813, 1.2283531427383423, 1.232407569885254, 1.2364670038223267, 1.2405314445495605, 1.2446011304855347, 1.2486759424209595, 1.252755880355835, 1.2568409442901611, 1.260931134223938, 1.265026569366455, 1.2691271305084229, 1.2732329368591309, 1.277343988418579, 1.2814602851867676, 1.2855819463729858, 1.2897087335586548, 1.293840765953064, 1.2979782819747925, 1.3021209239959717, 1.3062689304351807, 1.310422420501709, 1.3145811557769775, 1.3187453746795654, 1.3229148387908936, 1.327089786529541, 1.3312702178955078, 1.335456132888794, 1.3396474123001099, 1.3438440561294556, 1.3480463027954102, 1.352254033088684, 1.3564672470092773, 1.3606860637664795, 1.364910364151001, 1.3691401481628418, 1.373375654220581, 1.3776166439056396, 1.3818632364273071, 1.3861154317855835, 1.3903733491897583, 1.394636869430542, 1.3989059925079346, 1.4031808376312256, 1.4074612855911255, 1.4117475748062134, 1.4160395860671997, 1.420337200164795, 1.4246407747268677, 1.4289500713348389, 1.433264970779419, 1.4375858306884766, 1.441912293434143, 1.446244716644287, 1.4505828619003296, 1.4549269676208496, 1.4592770338058472, 1.4636327028274536, 1.4679945707321167, 1.4723621606826782, 1.4767357110977173, 1.4811151027679443, 1.485500693321228, 1.4898920059204102, 1.4942893981933594, 1.4986927509307861, 1.50310218334198, 1.5075175762176514, 1.5119390487670898, 1.5163664817810059, 1.5208001136779785, 1.5252397060394287, 1.529685378074646, 1.53413724899292, 1.538595199584961, 1.5430593490600586, 1.5475294589996338, 1.5520060062408447, 1.5564885139465332, 1.5609772205352783, 1.5654722452163696, 1.5699734687805176, 1.5744807720184326, 1.5789945125579834, 1.5835143327713013, 1.5880407094955444, 1.5925731658935547, 1.5971119403839111, 1.6016571521759033, 1.6062085628509521, 1.6107664108276367, 1.615330457687378, 1.6199010610580444, 1.6244779825210571, 1.629061222076416, 1.6336510181427002, 1.6382471323013306, 1.6428496837615967, 1.6474586725234985, 1.6520742177963257, 1.6566962003707886, 1.6613247394561768, 1.6659595966339111, 1.67060124874115, 1.6752492189407349, 1.6799037456512451, 1.6845650672912598, 1.6892328262329102, 1.6939070224761963, 1.6985880136489868, 1.7032755613327026, 1.7079696655273438, 1.7126705646514893, 1.71737802028656, 1.7220921516418457, 1.7268130779266357, 1.7315404415130615, 1.7362748384475708, 1.7410156726837158, 1.7457635402679443, 1.7505179643630981, 1.7552790641784668, 1.7600470781326294, 1.7648218870162964, 1.7696034908294678, 1.7743918895721436, 1.7791870832443237, 1.7839891910552979, 1.7887980937957764, 1.7936139106750488, 1.7984366416931152, 1.803266167640686, 1.8081026077270508, 1.812946081161499, 1.8177963495254517, 1.8226536512374878, 1.8275178670883179, 1.8323891162872314, 1.837267279624939, 1.84215247631073, 1.847044587135315, 1.851943850517273, 1.8568501472473145, 1.86176335811615, 1.8666837215423584, 1.87161123752594, 1.8765456676483154, 1.8814873695373535, 1.886436104774475, 1.8913919925689697, 1.8963549137115479, 1.9013251066207886, 1.9063024520874023, 1.9112869501113892, 1.916278600692749, 1.9212775230407715, 1.926283597946167, 1.9312968254089355, 1.9363174438476562, 1.94134521484375, 1.9463802576065063, 1.9514226913452148, 1.9564722776412964, 1.9615291357040405, 1.9665933847427368, 1.9716647863388062, 1.9767438173294067, 1.9818300008773804, 1.9869235754013062, 1.992024540901184, 1.9971328973770142, 2.002248525619507, 2.0073719024658203, 2.0125021934509277, 2.0176403522491455, 2.0227856636047363, 2.0279386043548584, 2.0330991744995117, 2.038266897201538, 2.0434422492980957, 2.0486249923706055, 2.0538153648376465, 2.0590133666992188, 2.064218759536743, 2.069431781768799, 2.0746524333953857, 2.079880475997925, 2.085116147994995, 2.0903594493865967, 2.0956103801727295, 2.1008689403533936, 2.106135129928589, 2.1114089488983154, 2.1166903972625732, 2.1219794750213623, 2.1272764205932617, 2.1325809955596924, 2.1378931999206543, 2.1432132720947266, 2.14854097366333, 2.153876304626465, 2.15921950340271, 2.1645703315734863, 2.169929027557373, 2.17529559135437, 2.1806697845458984, 2.186051845550537, 2.191441774368286, 2.1968393325805664, 2.202244997024536, 2.207658529281616, 2.2130796909332275, 2.2185089588165283, 2.2239458560943604, 2.229390859603882, 2.2348437309265137, 2.240304470062256, 2.2457733154296875, 2.2512497901916504, 2.2567343711853027, 2.2622270584106445, 2.2677276134490967, 2.273236036300659, 2.278752565383911, 2.2842772006988525, 2.2898097038269043, 2.2953503131866455, 2.300899028778076, 2.306455612182617, 2.3120203018188477, 2.3175930976867676, 2.323173999786377, 2.328763008117676, 2.334360122680664, 2.339965343475342, 2.345578670501709, 2.3512001037597656, 2.3568296432495117, 2.3624675273895264, 2.3681135177612305, 2.373767614364624, 2.379429817199707, 2.3851003646850586, 2.3907790184020996, 2.396466016769409, 2.4021613597869873, 2.407864809036255, 2.413576602935791, 2.4192965030670166, 2.4250245094299316, 2.4307610988616943, 2.4365060329437256, 2.442258834838867, 2.4480204582214355, 2.4537901878356934, 2.459568500518799, 2.4653546810150146, 2.4711496829986572, 2.4769527912139893, 2.48276424407959, 2.488584280014038, 2.494412660598755, 2.5002493858337402, 2.506094455718994, 2.5119481086730957, 2.517810106277466, 2.5236806869506836, 2.52955961227417, 2.535446882247925, 2.5413427352905273, 2.5472471714019775, 2.5531599521636963, 2.559081554412842, 2.5650112628936768, 2.5709497928619385, 2.576896905899048, 2.582852363586426, 2.5888164043426514, 2.5947890281677246, 2.6007702350616455, 2.606760025024414, 2.6127586364746094, 2.6187655925750732, 2.6247811317443848, 2.630805492401123, 2.636838436126709, 2.6428799629211426, 2.648930311203003, 2.654989004135132, 2.6610567569732666, 2.66713285446167, 2.6732177734375, 2.679311513900757, 2.6854138374328613, 2.6915249824523926, 2.6976447105407715, 2.703773260116577, 2.7099106311798096, 2.7160568237304688, 2.7222115993499756, 2.728375196456909, 2.7345476150512695, 2.7407288551330566, 2.7469189167022705, 2.753117799758911, 2.7593255043029785, 2.7655420303344727, 2.7717673778533936, 2.778001546859741, 2.7842445373535156, 2.790496587753296, 2.796757459640503, 2.803027391433716, 2.8093059062957764, 2.8155934810638428, 2.821889877319336, 2.828195333480835, 2.83450984954834, 2.8408329486846924, 2.847165107727051, 2.853506565093994, 2.859856605529785, 2.866215944290161, 2.872584104537964, 2.8789613246917725, 2.885347604751587, 2.891742706298828, 2.898146867752075, 2.904560089111328, 2.910982608795166, 2.9174139499664307, 2.923854351043701, 2.9303040504455566, 2.936762571334839, 2.943230390548706, 2.94970703125, 2.956192970275879, 2.9626882076263428, 2.9691922664642334, 2.975705623626709, 2.9822280406951904, 2.9887595176696777, 2.99530029296875, 3.0018503665924072, 3.0084095001220703, 3.0149776935577393, 3.0215554237365723, 3.028141975402832, 3.0347378253936768, 3.0413432121276855, 3.047957420349121, 3.0545811653137207, 3.061213970184326, 3.0678560733795166, 3.074507474899292, 3.0811681747436523, 3.0878381729125977, 3.094517469406128, 3.101206064224243, 3.1079039573669434, 3.1146111488342285, 3.1213278770446777, 3.128053665161133, 3.134788751602173, 3.141533374786377, 3.148287296295166, 3.15505051612854, 3.161823272705078, 3.168605327606201, 3.175396680831909, 3.1821975708007812, 3.1890077590942383, 3.1958274841308594, 3.2026567459106445, 3.2094953060150146, 3.2163431644439697, 3.223200559616089, 3.230067491531372, 3.2369439601898193, 3.2438297271728516, 3.250725269317627, 3.2576301097869873, 3.2645442485809326, 3.271468162536621, 3.2784016132354736, 3.285344362258911, 3.292296886444092, 3.2992589473724365, 3.3062305450439453, 3.313211441040039, 3.320202112197876, 3.327202320098877, 3.334212303161621, 3.34123158454895, 3.3482606410980225, 3.355299234390259, 3.3623476028442383, 3.3694052696228027};
// clang-format on

inline at::TensorOptions get_options(const at::ScalarType& dtype, const at::DeviceType& device)
{
    return at::TensorOptions().dtype(dtype).device(device);
}

float interp_fn(float x, int x1, float y1, int x2, float y2)
{
    if (x2 == x1) {
        return y1;
    }
    return y1 + (x - static_cast<float>(x1)) * (y2 - y1) / static_cast<float>(x2 - x1);
}

std::vector<float> np_interp(const std::vector<float>& timesteps)
{
    std::vector<float> results;
    constexpr int      n = 1100;

    for (auto& x : timesteps) {
        int idx = static_cast<int>(x);
        if (idx < 0) {
            results.push_back(sigmas[0]);
        }
        else if (idx >= n - 1) {
            results.push_back(sigmas[n - 1]);
        }
        else {
            results.push_back(interp_fn(x, idx, sigmas[idx], idx + 1, sigmas[idx + 1]));
        }
    }

    return results;
}

class TextEmbeddingModel {
public:
    int batch_size;
    int seq_len;
    int emb_dim;

private:
    libtrt::Engine m_engine;

    at::Tensor m_input_ids;
    at::Tensor m_attn_mask;
    at::Tensor m_pos_ids;
    at::Tensor m_text_emb;
    at::Tensor m_text_proj;

    std::vector<int> m_positive_ids_vec;
    std::vector<int> m_negative_ids_vec;
    std::vector<int> m_positive_pos_ids_vec;
    std::vector<int> m_negative_pos_ids_vec;

public:
    TextEmbeddingModel(const std::string& engine_path): m_engine(engine_path, 0, 0)
    {
        batch_size = m_engine.GetInput(0)->GetDims(0);
        seq_len    = m_engine.GetInput(0)->GetDims(1);
        emb_dim    = m_engine.GetOutput(0)->GetDims(2);

        m_positive_ids_vec.resize(seq_len, 0);
        m_negative_ids_vec.resize(seq_len, 0);
        m_positive_pos_ids_vec.resize(seq_len, 0);
        m_negative_pos_ids_vec.resize(seq_len, 0);

        int*   input_ids_ptr = reinterpret_cast<int*>(m_engine.GetInput(0)->GetPtr());
        int*   attn_mask_ptr = reinterpret_cast<int*>(m_engine.GetInput(1)->GetPtr());
        int*   pos_ids_ptr   = reinterpret_cast<int*>(m_engine.GetInput(2)->GetPtr());
        float* text_emb_ptr  = reinterpret_cast<float*>(m_engine.GetOutput(0)->GetPtr());
        float* text_proj_ptr = reinterpret_cast<float*>(m_engine.GetOutput(1)->GetPtr());

        m_input_ids = torch::from_blob(input_ids_ptr, {batch_size, seq_len}, get_options(torch::kInt32, torch::kCUDA));
        m_attn_mask = torch::from_blob(attn_mask_ptr, {batch_size, seq_len}, get_options(torch::kInt32, torch::kCUDA));
        m_pos_ids   = torch::from_blob(pos_ids_ptr, {batch_size, seq_len}, get_options(torch::kInt32, torch::kCUDA));
        m_text_emb =
            torch::from_blob(text_emb_ptr, {batch_size, seq_len, emb_dim}, get_options(torch::kFloat32, torch::kCUDA));
        m_text_proj =
            torch::from_blob(text_proj_ptr, {batch_size, emb_dim}, get_options(torch::kFloat32, torch::kCUDA));
    }

    std::vector<at::Tensor> forward(const std::vector<int>&                positive_ids,
                                    const std::optional<std::vector<int>>& negative_ids)
    {
        std::fill(m_positive_ids_vec.begin(), m_positive_ids_vec.end(), 0);
        std::fill(m_negative_ids_vec.begin(), m_negative_ids_vec.end(), 0);
        std::fill(m_positive_pos_ids_vec.begin(), m_positive_pos_ids_vec.end(), 0);
        std::fill(m_negative_pos_ids_vec.begin(), m_negative_pos_ids_vec.end(), 0);

        int cnt = 0;
        for (int i = 0; i < positive_ids.size(); ++i) {
            if (positive_ids[i] != 0) {
                m_positive_ids_vec[i]     = positive_ids[i];
                m_positive_pos_ids_vec[i] = cnt;
                cnt++;
            }
        }

        std::vector<int> negative_ids_vec;
        if (negative_ids.has_value()) {
            negative_ids_vec = negative_ids.value();
        }
        else {
            negative_ids_vec = {64790, 64792};
        }

        for (int cnt = 0, i = seq_len - negative_ids_vec.size(); i < seq_len; ++i, ++cnt) {
            m_negative_ids_vec[i]     = negative_ids_vec[cnt];
            m_negative_pos_ids_vec[i] = cnt;
        }

        std::vector<int> all_input_ids, all_pos_ids;
        all_input_ids.insert(all_input_ids.end(), m_negative_ids_vec.begin(), m_negative_ids_vec.end());
        all_input_ids.insert(all_input_ids.end(), m_positive_ids_vec.begin(), m_positive_ids_vec.end());

        all_pos_ids.insert(all_pos_ids.end(), m_negative_pos_ids_vec.begin(), m_negative_pos_ids_vec.end());
        all_pos_ids.insert(all_pos_ids.end(), m_positive_pos_ids_vec.begin(), m_positive_pos_ids_vec.end());

        at::Tensor input_ids =
            torch::from_blob(all_input_ids.data(), {batch_size, seq_len}, get_options(torch::kInt32, torch::kCPU));
        at::Tensor attn_mask = input_ids != 0;
        at::Tensor pos_ids =
            torch::from_blob(all_pos_ids.data(), {batch_size, seq_len}, get_options(torch::kInt32, torch::kCPU));

        m_input_ids.copy_(input_ids);
        m_attn_mask.copy_(attn_mask.to(torch::kInt32));
        m_pos_ids.copy_(pos_ids);

        m_engine.Call();

        return {m_text_emb.clone(), m_text_proj.clone()};
    }
};

class UnetModel {
public:
    int batch_size;
    int height;
    int width;
    int emb_size;
    int seq_len;

private:
    libtrt::Engine m_engine;

    at::Tensor m_noisy_input;
    at::Tensor m_time_step;
    at::Tensor m_prompt_emb;
    at::Tensor m_text_emb;
    at::Tensor m_output;

public:
    UnetModel(const std::string& engine_path): m_engine(engine_path, 0, 0)
    {
        batch_size = m_engine.GetInput(0)->GetDims(0);
        height     = m_engine.GetInput(0)->GetDims(2);
        width      = m_engine.GetInput(0)->GetDims(3);
        emb_size   = m_engine.GetInput(2)->GetDims(2);
        seq_len    = m_engine.GetInput(2)->GetDims(1);

        float* noisy_input_ptr = reinterpret_cast<float*>(m_engine.GetInput(0)->GetPtr());
        float* time_step_ptr   = reinterpret_cast<float*>(m_engine.GetInput(1)->GetPtr());
        float* prompt_emb_ptr  = reinterpret_cast<float*>(m_engine.GetInput(2)->GetPtr());
        float* text_emb_ptr    = reinterpret_cast<float*>(m_engine.GetInput(3)->GetPtr());
        float* output_ptr      = reinterpret_cast<float*>(m_engine.GetOutput(0)->GetPtr());

        m_noisy_input =
            torch::from_blob(noisy_input_ptr, {batch_size, 4, height, width}, get_options(torch::kFloat32, at::kCUDA));
        m_time_step = torch::from_blob(time_step_ptr, {batch_size}, get_options(torch::kFloat32, at::kCUDA));
        m_prompt_emb =
            torch::from_blob(prompt_emb_ptr, {batch_size, seq_len, emb_size}, get_options(torch::kFloat32, at::kCUDA));
        m_text_emb = torch::from_blob(text_emb_ptr, {batch_size, emb_size}, get_options(torch::kFloat32, at::kCUDA));

        m_output =
            torch::from_blob(output_ptr, {batch_size, 4, height, width}, get_options(torch::kFloat32, at::kCUDA));
    }

    at::Tensor forward(const at::Tensor& noisy_input,
                       const at::Tensor& time_step,
                       const at::Tensor& prompt_emb,
                       const at::Tensor& text_emb)
    {
        m_noisy_input.copy_(noisy_input);
        m_time_step.copy_(time_step);
        m_prompt_emb.copy_(prompt_emb);
        m_text_emb.copy_(text_emb);
        m_engine.Call();
        return m_output.clone();
    }
};

class VaeModel {
public:
    int batch_size;
    int height;
    int width;

    int new_height;
    int new_width;

private:
    libtrt::Engine m_engine;

    at::Tensor m_noisy_input;
    at::Tensor m_output;

public:
    VaeModel(const std::string& engine_path): m_engine(engine_path, 0, 0)
    {
        batch_size = m_engine.GetInput(0)->GetDims(0);
        height     = m_engine.GetInput(0)->GetDims(2);
        width      = m_engine.GetInput(0)->GetDims(3);
        new_height = m_engine.GetOutput(0)->GetDims(2);
        new_width  = m_engine.GetOutput(0)->GetDims(3);

        float* noisy_input_ptr = reinterpret_cast<float*>(m_engine.GetInput(0)->GetPtr());
        float* output_ptr      = reinterpret_cast<float*>(m_engine.GetOutput(0)->GetPtr());

        m_noisy_input =
            torch::from_blob(noisy_input_ptr, {batch_size, 4, height, width}, get_options(torch::kFloat32, at::kCUDA));
        m_output = torch::from_blob(output_ptr, {1, 3, new_height, new_width}, get_options(torch::kFloat32, at::kCUDA));
    }

    at::Tensor forward(const at::Tensor& noisy_input)
    {
        m_noisy_input.copy_(noisy_input);
        m_engine.Call();
        return m_output.clone();
    }
};

class Pipeline {
public:
    int seed;
    int batch_size;
    int height;
    int width;
    int m_num_steps  = 50;
    int m_step_ratio = 22;

private:
    TextEmbeddingModel m_chatglm;
    UnetModel          m_kolors;
    VaeModel           m_vae;
    at::Tensor         m_time_steps;
    std::vector<float> m_sigmas;

public:
    Pipeline(const std::string& chatglm_engine_file,
             const std::string& kolor_engine_file,
             const std::string& vae_engine_file,
             int                seed = 42):
        m_chatglm(chatglm_engine_file), m_kolors(kolor_engine_file), m_vae(vae_engine_file), seed(seed)
    {
        batch_size = m_kolors.batch_size;
        height     = m_kolors.height;
        width      = m_kolors.width;

        set_time_steps(m_num_steps);
        at::manual_seed(seed);
    }

    void set_time_steps(int num_steps)
    {
        // timestep_spacing = "leading"
        m_num_steps  = num_steps;
        m_step_ratio = 1100 / m_num_steps;
        // steps_offset = 1

        float steps_offset = 1.f;

        std::vector<float> time_steps;

        for (int i = 0; i < m_num_steps; ++i) {
            float t = static_cast<float>(i * m_step_ratio) + steps_offset;
            time_steps.push_back(t);
        }

        std::reverse(time_steps.begin(), time_steps.end());

        std::vector<float> tmp_sigmas = np_interp(time_steps);
        tmp_sigmas.push_back(0.f);

        m_time_steps = torch::from_blob(time_steps.data(), {m_num_steps}, get_options(torch::kFloat32, at::kCPU));
        m_time_steps = m_time_steps.to(at::kCUDA);
        m_sigmas     = tmp_sigmas;
    }

    py::array_t<uint8_t> run(const std::vector<int>&                chatglm_input_ids,
                             const std::optional<std::vector<int>>& chatglm_neg_ids = std::nullopt,
                             int                                    num_steps       = 50)
    {
        bool first = true;
        if (num_steps != m_num_steps) {
            set_time_steps(num_steps);
        }
        progressbar bar(m_num_steps);
        bar.set_todo_char(" ");
        bar.set_done_char("█");
        std::vector<at::Tensor> chatglm_outputs = m_chatglm.forward(chatglm_input_ids, chatglm_neg_ids);
        at::Tensor              noisy_input     = at::randn({1, 4, height, width}, get_options(at::kFloat, at::kCUDA));
        noisy_input                             = noisy_input * 25.3011f;
        // do_classifier_free_guidance
        for (int i = 0; i < m_num_steps; ++i) {

            int   step  = m_time_steps[i].item().toInt();
            float sigma = m_sigmas[i];
            float gamma = 0.f;

            at::Tensor latent_model_input = at::tile(noisy_input, {batch_size, 1, 1, 1});
            latent_model_input            = latent_model_input / std::sqrt(sigma * sigma + 1.f);

            at::Tensor t_expand = at::tensor({step}, get_options(at::kFloat, at::kCUDA));
            at::Tensor latent_model_output =
                m_kolors.forward(latent_model_input, t_expand, chatglm_outputs[0], chatglm_outputs[1]);

            std::vector<at::Tensor> latent_model_outputs = at::chunk(latent_model_output, 2, 0);
            at::Tensor noise_pred = latent_model_outputs[0] + 5.f * (latent_model_outputs[1] - latent_model_outputs[0]);

            at::Tensor variance_noise = at::randn_like(noise_pred);
            at::Tensor eps            = variance_noise * 1.f;
            float      sigma_hat      = sigma * (gamma + 1.f);

            at::Tensor pred_original_sample = noisy_input - sigma_hat * noise_pred;
            // derivative = noise_pred
            at::Tensor derivative  = (noisy_input - pred_original_sample) / sigma_hat;
            float      dt          = sigmas[i + 1] - sigma_hat;
            at::Tensor prev_sample = noisy_input + derivative * dt;
            noisy_input            = prev_sample;
            bar.update();
        }
        std::cout << "\n";

        at::Tensor image = m_vae.forward(noisy_input);
        image            = image * 255.f;
        image            = image.round();
        image            = image.to(at::kByte);
        image            = image[0].permute({1, 2, 0}).contiguous();
        image            = image.to(at::kCPU);
        return py::array(image.sizes(), image.data_ptr<uint8_t>());
    }
};

PYBIND11_MODULE(py_kolors, m)
{
    m.doc() = R"(py_kolors module provided by triple-mu!)";
    SET_ATTR_TO(m, "__version__", "0.0.1");
    SET_ATTR_TO(m, "__author__", "triple-mu");
    SET_ATTR_TO(m, "__email__", "gpu@163.com");
    SET_ATTR_TO(m, "__date__", "2024-07-08");
    SET_ATTR_TO(m, "__qq__", "3394101");

    py::class_<Pipeline>(m, "Pipeline")
        .def(py::init<const std::string&, const std::string&, const std::string&, int>(),
             py::arg("chatglm_engine_file"),
             py::arg("unet_engine_file"),
             py::arg("vae_engine_file"),
             py::arg("seed") = 0,
             "Initialize the pipeline")
        .def("generate",
             &Pipeline::run,
             py::arg("chatglm_input_ids"),
             py::arg("chatglm_neg_ids") = std::nullopt,
             py::arg("steps")           = 50);
}